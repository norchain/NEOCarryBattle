#《卡莱战纪》技术篇

《卡莱战纪》是一款模拟拜占庭将军问题的卡牌链游。由norchain.io 基于NEO区块链基础设施的开发. 技术方面尝试了以下内容并将目前已实现的部分全部开源.



## 引擎层

由于卡莱战纪尝试逻辑上链, 不仅于代币交易, 所以链上逻辑规模相对很大(不是指每次Invoke逻辑都大). 为了能实现大规模逻辑上链的需求, 感谢此次比赛的激励, 我们在研发卡莱战纪的同时研发并开源了一套框架[Neunity](https://github.com/norchain/Neunity).

总体上, Neunity对NEO合约及DAPP的研发体系分**两阶段**和**三层次**(如下图所示)

![Neunity](pics/Neunity.jpg)

- 两阶段:**研发**阶段使用嵌入在客户端中的模拟链实现完全脱链完成,无需私链搭建或连接. **测试**阶段
- 三层次: 

1. [已实现] 研发阶段可以在Unity前端内部实现对合约逻辑的**断点调试**及**测试用例**, **无需私链搭建或连接**. 并且可以把合约直接作为前端逻辑一部分,统一研发.教程视频: [Youtube](https://youtu.be/vTkNzx403p8). 

2. [已实现] **自定义序列化方法NuSD**. 可提供自定义的灵活序列化方法(可以类嵌套) ([源码](https://github.com/norchain/Neunity/blob/master/Neunity/Neunity/Tools/NUSerialization.cs)), ([例子](https://github.com/norchain/Neunity/blob/master/Samples/SampleUnity/SmartContract/SmartContract/Scripts/SmartContract/SmartContract.cs)). 我们还制定了NuSD表述规范来统一“前后端”关于某个对象转成字节数组后的结构描述. 

   ```xml
   例子:
   
   1. Card类型的NuSD描述
   <Card> = [S<id>,S<name>,S<birthBlock>,S<level>,S<ownerId>,S<isFighting#1>]
   (<>:字段内容, S:添加前缀, []:并列列表, #n:长度固定为n字节)
       
   2. User类型NuSD描述
   <User> = [S<id>,S[S<Card>*3],[S<warId>*]]
   (*:重复若干次, *m:固定重复m次, S[S<Card>*3]表示嵌入3个加前缀的Card字符数组,然后再加前缀)
       
   ```

   另外, NuSD使用变长前缀算法比官方更省空间(在卡莱里压缩Storage约20%). 注:由于缺少Opcode支持, 目前花费GAS会比较多, 但在优化中.

   ![NuSD](pics/NuSD.png)

3. [已实现] **仿HTTP标准Response**. 大规模协约代码在协作研发时在通信层的逻辑统一有两个挑战: 

   基于这个实战需求,我们在NuSD基础上研发了仿HTTP协议NuTP(Neunity Transfer Protocol) 从此后前端可以执行标准的: 

   * 由于返回值(或读取Storage)只有Byte[], 前端很不容易判断问题. 

   * 懂NEO的开发者目前还很少, 前端希望有一套对他们相对熟悉的方法来实现逻辑. 

```cs
//前端函数:获取用户完全信息
public void CarryGetUser()
    {
        //... 准备各种参数 ...
    
		// 调用链上函数: 调试阶段就在本地; 测试阶段通过Neo-Lux RPC
        NuTP.Response response = NuContract.InvokeWithResp("<RPC Endpoint>", operation, paras);
		
        if(response.header.code == NuTP.Code.Success){	//仿HTTP错误码
            //从response.body提取内容, 并可以直接复用合约内的逻辑代码(RW.Bytes2User(), RW.Table2Cards()等)
            CarryBattleSC.User user = RW.Bytes2User(NuSD.SplitTbl(response.body,0));
            CarryBattleSC.Card[] cards = RW.Table2Cards(NuSD.SplitTbl(response.body, 1));
            Debug.Log(cards.Length);
        }
        else{
			//异常处理
        }
    }
```



4. [已实现] **URI式Storage管理**. 我们发现NEO的Storage两个特点:

   * 只支持单层Key-Value. StorageMap可以模拟实现两层
   * 当对一个Key写多次相同值时, 每次依然扣除1GAS
   * 当对一个Key写空值时, 效果其实和删除相同, 但相比删除使用0.1GAS,这个操作还是扣1GAS.

   为此我们开发了NuIO对Storage管理进行封装. 实现了类似URI的结构.

   ```cs
   //读操作: key= "server/{sID}/user/{uID}/card/{cID}"
   byte[] cardData = NuIO.GetStorageWithKeyPath("server",sID, "user", uID, "card", cID);
   
   //写操作:cardData为内容, key = "server/{sID}/user/{uID}/card/{cID}
   //此操作在写重复值或空值时只消耗0.1个GAS
   NuIO.SetStorageWithKeyPath(cardData, "server",sID, "user", uID, "card", cID);
   
   
   ```


5. [部分实现] **与Neo-lux无缝衔接**. 目标是前端只需要改一个参数就能在本地调试合约和私链测试间切换.
6. [计划] Neunity下一步计划包括:
   * Tool层(NuIO,NuSD及NuTP所在层) 接入NEL/BlaCat 钱包
   * 和neocomipler.io 协作实现持续集成
   * 研发调试阶段可以任意模拟



* 

## 算法层





## 业务层



我们是当作一款真正能有商业上有发展前景的链游去设计《卡莱战纪》的。除了创新的玩法外，我们还努力在设计细节上避免了仅仅资产上链而带来的价值陷阱，同时针对区块链游戏信息透明及协约调用费用对游戏带来的负面因素提出了**信息补贴**和**软分服**设计方法。

## 基本玩法

玩家注册游戏帐户时拿到随机生成的10张卡牌，每张牌是步、弓、骑其中一种，在3x3格子里排成阵型。

在地图上有一些历史名城，玩家可以去占领一个空城池，也可以去进攻别人的城池。占领城市的领主可以根据占领时长领取分数奖励（税收），每个城市的奖励因子不一样。

玩家(P0) 查看各个城市的守军的卡牌布局后，仔细安排自己的卡牌阵型，然后向守军P1的城市C发起进攻。此时P0进入**行军阶段**。

在*行军阶段*结束前，其他玩家可以加入战局。加入战局时他们需要宣称支持攻方或守方，同时需暗地指定自己实际支持的派别。（注：如何在开放信息的区块链上暂时隐瞒自己的实际支持派别，将在技术篇讨论）

当行军阶段结束后，战局进入**攻城阶段**。此时各玩家需公布自己的实际支持派别（这个公布将由算法保障无法和之前决定的支持派别违背）。如果玩家在此阶段未公布，视为中途退出战局，并被惩罚冷却时间。

实际参与到双方的玩家会对攻守各自加成，以一定算法结算后，战利分数由胜方按**信息补贴**(参看*设计特色*)原则分配。

战争结束后，若守方P1战败则退出城市，P0占领该城后开始享有税收。

税收和战争胜利获得的分数可以用来升级玩家卡牌。



![map](pics/map.jpg)

![battle](pics/Battle.jpg)



## 设计特色

### 1. 全逻辑上链

《卡莱战纪》为全逻辑上链游戏。除了某些图片资源的链接外，玩家无需中心化服务器（本来也没有）甚至无需客户端皆可进行游戏。全逻辑上链（相比仅仅资产上链）的另一个好处是：**玩家资产不仅永远不会丢，而且永远能有用**。（注：天气系统除外，见下文）

### 2. 全平台移植

iPhone, 安卓与网页， 想玩就玩。卡莱战纪将配备Unity客户端，可无缝移植到iPhone, 安卓与页游。开发团队具有多年研发并运营百万用户级别游戏产品经验，将根据跨平台需求细致打造用户体验。

### 3. 信息补贴

全链PvP游戏一个无法回避的问题是：由于信息公开，一次会战的后参与者始终会因为掌握更多信息而把握更多胜算（传统网游里可以通过服务器暂时隐瞒各玩家输入避免这个问题）。这种情况在某些玩法里甚至可能是摧毁性的。为此我们引入下图所示的信息补贴算法，让风险偏好不同的玩家找到自己的位置。

![InfoCompensation](pics/InfoCompensation.jpg) 



### 4. 软分服

由于NEO区块链单层存储结构，当玩家及道具量增大到一定程度时GAS成本就会急剧上升。比如：对一次涉及上千不同道具或玩家的查读写操作几乎必然超过10GAS。所以在链上分服几乎是必然。然而传统分服方法及各服参数受中心化影响太大会影响玩家资产价值。

![ProbServers](pics/ProbServers.jpg)

我们的解决方案是软分服。如下图所示，在协约里不设置各服人数上限及等级范围的硬值，由玩家自己平衡收益与利弊最后自然形成各服布局。

![SoftServers](pics/SoftServers.jpg)



### 5. 结合现实世界数据

《卡莱战役》另一个设计因素是结合真实世界。卡莱战役作为具有宏大历史背景的游戏，游戏里的时空都和现实世界紧密联系。具体而言，

* 每个服务器里的时间都将在公元前50年走到公元50年然后覆灭重启。在此期间所有相关的东西方著名历史人物都会出现在他们当年所在的位置而对战局产生影响。
* 每个城市影响战局的地形数据都是从真实世界提取。
* 参战时的天气由一个先知帐号从天气预报台读取然后每小时发送到区块链上。



![mapFull](pics/mapFull.jpg)

## 常见疑问

